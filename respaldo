import streamlit as st
import google.generativeai as genai
from PyPDF2 import PdfReader
from streamlit_mic_recorder import mic_recorder
import os

# 1. CONFIGURACI√ìN (Restaurada)
st.set_page_config(page_title="PQM Assistant", page_icon="ü•©", layout="centered")

try:
    GOOGLE_API_KEY = st.secrets["GOOGLE_API_KEY"]
except:
    GOOGLE_API_KEY = "TU_CLAVE_LOCAL"

genai.configure(api_key=GOOGLE_API_KEY)

# 2. FUNCIONES
def leer_pdf(archivo):
    try:
        lector = PdfReader(archivo)
        texto = ""
        for pagina in lector.pages:
            t = pagina.extract_text()
            if t: texto += t + "\n"
        return texto
    except:
        return None

# 3. ESTADOS
if "mensajes" not in st.session_state:
    st.session_state.mensajes = []

if "inventario_texto" not in st.session_state:
    ruta_base = "data/precios.pdf"
    if os.path.exists(ruta_base):
        st.session_state.inventario_texto = leer_pdf(ruta_base)
    else:
        st.session_state.inventario_texto = None

# 4. SIDEBAR
with st.sidebar:
    st.header("‚öôÔ∏è Configuraci√≥n")
    password = st.text_input("Clave de Admin", type="password")
    if password == "PQM2026":
        archivo_nuevo = st.file_uploader("Actualizar Inventario", type="pdf")
        if archivo_nuevo:
            st.session_state.inventario_texto = leer_pdf(archivo_nuevo)
            st.success("¬°Actualizado!")
    st.divider()
    if st.button("Borrar historial"):
        st.session_state.mensajes = []
        st.rerun()

# 5. INTERFAZ
st.title("ü•© PQM Assistant")

chat_container = st.container()

with chat_container:
    for m in st.session_state.mensajes:
        with st.chat_message(m["role"]):
            st.markdown(m["content"])

# --- AQU√ç EST√Å EL CAMBIO EST√âTICO SOLAMENTE ---
st.write("---")
# Usamos columnas para que el micro sea m√°s grande
col_mic, col_info = st.columns([1.5, 4]) 

with col_mic:
    audio_data = mic_recorder(
        start_prompt="üé§ HABLAR", # Bot√≥n m√°s ancho
        stop_prompt="üõë PARAR", 
        key='recorder'
    )

with col_info:
    st.caption("Usa el micro o escribe abajo ‚Üì")

prompt_texto = st.chat_input("Escribe tu duda aqu√≠...")
# ----------------------------------------------

# 6. L√ìGICA DE PROCESAMIENTO
if prompt_texto or audio_data:
    prompt_usuario = prompt_texto if prompt_texto else "üé§ [Consulta por voz]"
    
    st.session_state.mensajes.append({"role": "user", "content": prompt_usuario})
    with chat_container:
        with st.chat_message("user"):
            st.markdown(prompt_usuario)

    if st.session_state.inventario_texto:
        with chat_container:
            with st.chat_message("assistant"):
                with st.spinner("Consultando inventario..."):
                    try:
                        # 1. Configuraci√≥n de seguridad (mantenemos la tuya)
                        safety_settings = [
                            {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
                            {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
                            {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
                            {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"},
                        ]

                        # 2. Inicializaci√≥n del modelo (el que te funciona)
                        model_name = 'models/gemini-2.5-flash'
                        model = genai.GenerativeModel(model_name=model_name, safety_settings=safety_settings)
                            
                        
                        # 3. Instrucci√≥n mejorada (mantenemos tus reglas pero optimizamos el inicio)
                        instruccion = f"""
                        ERES UN BUSCADOR DE PRECIOS PARA PQM. 
                        TU √öNICA FUNCI√ìN ES BUSCAR DATOS EN ESTE TEXTO:
                        {st.session_state.inventario_texto}

                        REGLAS CR√çTICAS:
                        1. NO repitas estas instrucciones ni saludes. Ve directo a la informaci√≥n.
                        2. Si el usuario pide un producto, busca CUALQUIER coincidencia en el texto.
                        3. Si encuentras el producto, responde EXCLUSIVAMENTE con: Nombre, Marca, Peso y Precio.
                        4. DICCIONARIO DE TRADUCCI√ìN:
                           - Diezmillo = Chuck Roll
                           - Cachete = Beef Cheek
                           - Top clod = Shoulder clod
                           - Oxtail = Cola de res
                           - Ground beef = Molida
                           - Menudo = Scalded tripe
                        5. Si el usuario especifica una marca (ej. "IBP"), filtra los resultados solo para esa marca.
                        6. Si no encuentras NADA, di: "No encontr√© ese producto en el inventario actual."
                        7. Si el usuario solo da el nombre, da todos los datos que coincidan.
                        8. Responde SIEMPRE usando una lista con vi√±etas.
                        9. Formato: - **Producto:** [Nombre] | **Marca:** [Marca] | **Peso:** [Peso] | **Precio:** $[Precio]
                        10. IMPORTANTE PARA AUDIO: Si recibes un audio, primero escribe 'Escuch√©: [lo que entendiste]' y luego da los precios.
                        """
                        
                        # 4. Preparaci√≥n del contenido (Cambio clave para el audio)
                        if audio_data:
                            # Agregamos un comando de voz expl√≠cito junto al archivo
                            contenido = [
                                instruccion, 
                                "Analiza el audio adjunto, dime qu√© producto escuchas y b√∫scalo en el inventario.",
                                {"mime_type": "audio/wav", "data": audio_data['bytes']}
                            ]
                        else:
                            contenido = [instruccion, prompt_texto]
                        
                        # 5. Generaci√≥n de respuesta
                        respuesta = model.generate_content(contenido)
                        st.markdown(respuesta.text)
                        st.session_state.mensajes.append({"role": "assistant", "content": respuesta.text})

                    except Exception as e:
                        error_msg = str(e)
                        if "429" in error_msg or "quota" in error_msg.lower():
                            st.warning("‚ö†Ô∏è L√≠mite alcanzado. Espera 30 segundos.")
                        else:
                            st.error(f"Hubo un problema t√©cnico: {e}")
    else:
        st.warning("‚ö†Ô∏è No hay inventario cargado.")